apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kestra
  namespace: kestra
spec:
  interval: 5m
  chart:
    spec:
      chart: kestra
      version: "*"
      sourceRef:
        kind: HelmRepository
        name: kestra
        namespace: kestra
      interval: 1m
  values:
    image:
      tag: latest
      pullPolicy: IfNotPresent
    
    # Deployment configuration - standalone mode for simplicity
    deployments:
      standalone:
        enabled: true
        replicas: 1
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
      
      # Disable individual services in favor of standalone
      webserver:
        enabled: false
      executor:
        enabled: false
      indexer:
        enabled: false
      scheduler:
        enabled: false
      worker:
        enabled: false
    
    # Use external PostgreSQL configuration
    postgresql:
      enabled: false
    
    # Use internal MinIO for object storage
    minio:
      enabled: false
    
    # Configuration for Kestra using application format
    configurations:
      application:
        kestra:
          queue:
            type: postgres
          repository:
            type: postgres
          storage:
            type: local
            local:
              basePath: "/tmp/kestra-storage"
        datasources:
          default:
            url: jdbc:postgresql://kestra-postgresql:5432/kestra
            driverClassName: org.postgresql.Driver
            username: kestra
            password: "6ome6bd7pRltxCRWE4nSQov/BM0b3LvLXg6aa8k/AVk="
    
    # Security context
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
    
    # Service configuration
    service:
      type: ClusterIP
      port: 8080
    
    # Enable ingress later via separate manifest
    ingress:
      enabled: false