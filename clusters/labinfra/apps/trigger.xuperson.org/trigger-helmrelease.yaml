apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: trigger
  namespace: trigger
spec:
  interval: 15m
  chart:
    spec:
      chart: trigger
      version: "~4.0.0-beta"
      sourceRef:
        kind: HelmRepository
        name: trigger
        namespace: flux-system
      interval: 15m
  install:
    createNamespace: true
  upgrade:
    remediation:
      retries: 3
  values:
    global:
      external:
        postgres: false
        redis: false
        storage: false
      
      secrets:
        existingSecret: "trigger-secrets"
        sessionSecret: "session-secret"
        magicLinkSecret: "magic-link-secret"
        encryptionKey: "encryption-key"
        managedWorkerSecret: "worker-secret"
    
    webapp:
      enabled: true
      replicaCount: 1
      
      image:
        registry: docker.io
        repository: triggerdotdev/trigger.dev
        tag: "v4.0.0-beta.76"
      
      resources:
        limits:
          cpu: 1000m
          memory: 2Gi
        requests:
          cpu: 500m
          memory: 1Gi
      
      service:
        type: ClusterIP
        port: 3000
      
      env:
        LOGIN_ORIGIN: "https://trigger.xuperson.org"
        APP_ORIGIN: "https://trigger.xuperson.org"
        PLATFORM_HOST: "trigger.xuperson.org"
        WHITELISTED_EMAILS: "trigger@xuperson.org"
        FROM_EMAIL: "trigger@xuperson.org"
        REPLY_TO_EMAIL: "trigger@xuperson.org"
        AUTH_RESEND_API_KEY: ""
        DATABASE_URL: "postgresql://trigger:$(database-password)@trigger-postgresql:5432/trigger"
        REDIS_HOST: "trigger-redis-master"
        REDIS_PORT: "6379"
        OBJECT_STORE_PROVIDER: "s3"
        S3_BUCKET: "trigger-uploads"
        S3_ENDPOINT: "http://trigger-minio:9000"
        S3_ACCESS_KEY_ID: "$(minio-access-key)"
        S3_SECRET_ACCESS_KEY: "$(minio-secret-key)"
        S3_REGION: "us-east-1"
    
    supervisor:
      enabled: true
      replicaCount: 1
      
      image:
        registry: docker.io
        repository: triggerdotdev/trigger.dev
        tag: "v4.0.0-beta.76"
      
      resources:
        limits:
          cpu: 1000m
          memory: 1Gi
        requests:
          cpu: 500m
          memory: 512Mi
    
    postgres:
      enabled: false
    
    redis:
      enabled: false
    
    clickhouse:
      enabled: true
      image:
        registry: docker.io
        repository: clickhouse/clickhouse-server
        tag: "24.10"
      
      resources:
        limits:
          cpu: 1000m
          memory: 2Gi
        requests:
          cpu: 500m
          memory: 1Gi
      
      persistence:
        enabled: true
        size: 20Gi
        storageClass: "longhorn"
    
    minio:
      enabled: false