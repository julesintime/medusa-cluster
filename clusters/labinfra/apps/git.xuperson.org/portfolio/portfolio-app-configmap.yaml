---
apiVersion: v1
kind: ConfigMap
metadata:
  name: portfolio-app-code
  namespace: gitea
  labels:
    app.kubernetes.io/name: portfolio-app
    app.kubernetes.io/component: application-code
    app.kubernetes.io/managed-by: flux
data:
  Dockerfile: |
    FROM wordpress:6.4-php8.1-apache

    # Install required PHP extensions and tools
    RUN apt-get update && apt-get install -y \
        unzip \
        wget \
        && rm -rf /var/lib/apt/lists/*

    # Copy Avada theme and custom content
    COPY wp-content/ /var/www/html/wp-content/

    # Copy custom WordPress configuration
    COPY wp-config-docker.php /var/www/html/wp-config-docker.php

    # Set proper permissions
    RUN chown -R www-data:www-data /var/www/html/wp-content/ \
        && chmod -R 755 /var/www/html/wp-content/

    # Health check
    HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
        CMD curl -f http://localhost/ || exit 1

    EXPOSE 80

  wp-config-docker.php: |
    <?php
    /**
     * WordPress Docker Configuration
     * Custom configuration for containerized WordPress with Avada
     */

    // Database configuration from environment
    define('DB_NAME', getenv('WORDPRESS_DB_NAME') ?: 'wordpress');
    define('DB_USER', getenv('WORDPRESS_DB_USER') ?: 'wordpress');
    define('DB_PASSWORD', getenv('WORDPRESS_DB_PASSWORD') ?: 'wordpress');
    define('DB_HOST', getenv('WORDPRESS_DB_HOST') ?: 'localhost');
    define('DB_CHARSET', 'utf8mb4');
    define('DB_COLLATE', '');

    // Security keys (will be overridden by k8s secrets)
    define('AUTH_KEY',         getenv('WORDPRESS_AUTH_KEY') ?: 'put your unique phrase here');
    define('SECURE_AUTH_KEY',  getenv('WORDPRESS_SECURE_AUTH_KEY') ?: 'put your unique phrase here');
    define('LOGGED_IN_KEY',    getenv('WORDPRESS_LOGGED_IN_KEY') ?: 'put your unique phrase here');
    define('NONCE_KEY',        getenv('WORDPRESS_NONCE_KEY') ?: 'put your unique phrase here');
    define('AUTH_SALT',        getenv('WORDPRESS_AUTH_SALT') ?: 'put your unique phrase here');
    define('SECURE_AUTH_SALT', getenv('WORDPRESS_SECURE_AUTH_SALT') ?: 'put your unique phrase here');
    define('LOGGED_IN_SALT',   getenv('WORDPRESS_LOGGED_IN_SALT') ?: 'put your unique phrase here');
    define('NONCE_SALT',       getenv('WORDPRESS_NONCE_SALT') ?: 'put your unique phrase here');

    // WordPress table prefix
    $table_prefix = getenv('WORDPRESS_TABLE_PREFIX') ?: 'wp_';

    // WordPress debugging
    define('WP_DEBUG', getenv('WORDPRESS_DEBUG') === 'true');
    define('WP_DEBUG_LOG', getenv('WORDPRESS_DEBUG_LOG') === 'true');
    define('WP_DEBUG_DISPLAY', getenv('WORDPRESS_DEBUG_DISPLAY') === 'true');

    // WordPress URLs
    define('WP_HOME', getenv('WORDPRESS_HOME') ?: 'https://portfolio.xuperson.org');
    define('WP_SITEURL', getenv('WORDPRESS_SITEURL') ?: 'https://portfolio.xuperson.org');

    // File permissions
    define('FS_METHOD', 'direct');
    define('FS_CHMOD_DIR', (0755 & ~ umask()));
    define('FS_CHMOD_FILE', (0644 & ~ umask()));

    // Memory and upload limits
    ini_set('memory_limit', '512M');
    ini_set('upload_max_filesize', '100M');
    ini_set('post_max_size', '100M');
    ini_set('max_execution_time', 300);

    // Avada theme optimizations
    define('AVADA_VERSION', '7.11.0');
    define('WP_MEMORY_LIMIT', '512M');

    // WordPress absolute path
    if (!defined('ABSPATH')) {
        define('ABSPATH', dirname(__FILE__) . '/');
    }

    // Load WordPress
    require_once(ABSPATH . 'wp-settings.php');

  .dockerignore: |
    .git
    .gitignore
    README.md
    docker-compose.yml
    .env*
    .DS_Store
    Thumbs.db
    node_modules
    npm-debug.log*
    .nyc_output
    coverage
    .vscode
    .idea

  README.md: |
    # Avada Portfolio WordPress

    **Production-ready WordPress application with Avada theme for Kubernetes deployment.**

    ## Features

    - 🎨 **Avada Theme**: Premium WordPress theme pre-installed
    - 🚀 **GitOps CI/CD**: Automated builds with Gitea Actions + BuildKit
    - 🔧 **Kubernetes Ready**: Optimized for container deployment
    - 📦 **Database Integration**: MySQL/MariaDB support with Helm
    - 🔐 **Security**: WordPress security keys via Kubernetes secrets
    - 📈 **Performance**: Optimized PHP settings for Avada theme

    ## Architecture

    - **CI**: Gitea Actions with BuildKit remote building
    - **Runtime**: WordPress 6.4 + PHP 8.1 + Apache
    - **Theme**: Avada Premium Theme
    - **Database**: External MySQL via Kubernetes service
    - **Deployment**: GitOps with Flux CD

    ## Build Pipeline

    1. **Source**: Avada theme + custom wp-content
    2. **Build**: Docker image with BuildKit
    3. **Push**: Internal Gitea registry
    4. **Deploy**: Flux pulls and deploys automatically

    ## Configuration

    - WordPress configuration via environment variables
    - Security keys injected from Kubernetes secrets
    - Database connection via service discovery
    - File uploads and PHP limits optimized for Avada

    ## Local Development

    For local development, use the original Docker Compose setup in `projects/avada-portfolio/`.