---
apiVersion: v1
kind: ConfigMap
metadata:
  name: hello-labinfra-workflow
  namespace: gitea
  labels:
    app.kubernetes.io/name: hello-labinfra-workflow
    app.kubernetes.io/component: ci-cd
    app.kubernetes.io/managed-by: flux
data:
  buildkit-ci.yml: |
    name: Hello LabInfra CI/CD

    on:
      push:
        branches: [ main, master ]
      pull_request:
        branches: [ main, master ]

    jobs:
      build:
        name: Build and Deploy to Gitea Registry
        runs-on: ubuntu-latest
        steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Test BuildKit connection
          run: |
            echo "ğŸ”§ Testing BuildKit connectivity..."
            echo "BuildKit client version:"
            buildctl --version
            echo "Connecting to remote BuildKit service..."
            BUILDKIT_HOST=tcp://buildkitd.gitea.svc.cluster.local:1235 buildctl debug workers

        - name: Set image metadata
          run: |
            echo "ğŸ“‹ Setting up image metadata..."
            export BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            export BUILD_REF=${GITHUB_SHA:-$(git rev-parse HEAD 2>/dev/null || echo 'local')}
            export SHORT_SHA=$(echo $BUILD_REF | cut -c1-7)
            export IMAGE_TAG="${SHORT_SHA}-$(date +%s)"
            
            echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
            echo "BUILD_REF=$BUILD_REF" >> $GITHUB_ENV
            echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
            echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
            
            echo "ğŸ·ï¸  Build metadata:"
            echo "- Date: $BUILD_DATE"
            echo "- Ref: $BUILD_REF"
            echo "- Short SHA: $SHORT_SHA"
            echo "- Image Tag: $IMAGE_TAG"

        - name: Build and push to Gitea Package Registry
          run: |
            echo "ğŸ“¦ Building and pushing to Gitea Package Registry..."
            
            # Use BuildKit to build and push image
            BUILDKIT_HOST=tcp://buildkitd.gitea.svc.cluster.local:1235 buildctl build \
              --frontend dockerfile.v0 \
              --local context=. \
              --local dockerfile=. \
              --opt build-arg:BUILD_DATE=$BUILD_DATE \
              --opt build-arg:BUILD_REF=$BUILD_REF \
              --output type=image,name=git.xuperson.org/admin/hello-labinfra:$IMAGE_TAG,push=true \
              --output type=image,name=git.xuperson.org/admin/hello-labinfra:latest,push=true \
              --progress=plain

        - name: Deployment summary
          run: |
            echo "âœ… Build and deployment completed!"
            echo ""
            echo "ğŸ“¦ Images pushed to Gitea Package Registry:"
            echo "  ğŸ·ï¸  git.xuperson.org/admin/hello-labinfra:$IMAGE_TAG"
            echo "  ğŸ·ï¸  git.xuperson.org/admin/hello-labinfra:latest"
            echo ""
            echo "ğŸš€ Flux CD will automatically detect new image and update deployment!"
            echo "ğŸŒ Application will be available at: https://hello.xuperson.org"
