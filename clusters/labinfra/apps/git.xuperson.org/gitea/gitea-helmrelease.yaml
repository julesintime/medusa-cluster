apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: gitea
  namespace: gitea
spec:
  interval: 30m
  chart:
    spec:
      chart: gitea
      version: '*'
      sourceRef:
        kind: HelmRepository
        name: gitea-charts
        namespace: flux-system
      interval: 12h
  values:
    # Single instance deployment (no HA)
    replicaCount: 1
    strategy:
      type: RollingUpdate
    
    image:
      tag: "1.21"
    service:
      http:
        type: ClusterIP
        port: 3000
    extraEnvs:
    - name: GITEA__ACTIONS__ENABLED
      value: "true"
    - name: GITEA__SECURITY__SECRET_KEY
      valueFrom:
        secretKeyRef:
          name: gitea-admin-secret
          key: gitea-secret-key
    ingress:
      enabled: false
    gitea:
      admin:
        existingSecret: gitea-admin-secret
      config:
        server:
          ROOT_URL: "https://git.xuperson.org/"
        security:
          INSTALL_LOCK: true
          PASSWORD_COMPLEXITY: "off"
        actions:
          ENABLED: true
          LogRetentionDays: 30
          LogCompression: none
        repository:
          ENABLE_PUSH_CREATE_USER: true
          ENABLE_PUSH_CREATE_ORG: true
        service:
          DISABLE_REGISTRATION: false
          REQUIRE_SIGNIN_VIEW: false
        log:
          MODE: file,console
          LEVEL: Info
          LOG_SQL: false
          ROOT_PATH: /data/gitea/log
        webhook:
          ALLOWED_HOST_LIST: "*.cluster.local,*.svc.cluster.local,10.43.0.0/16,192.168.80.0/24"
    postgresql:
      enabled: true
      auth:
        existingSecret: "gitea-admin-secret"
        secretKeys:
          adminPasswordKey: "postgres-password"
          userPasswordKey: "postgres-password"
        username: "gitea"
        database: "gitea"
      primary:
        persistence:
          enabled: true
          storageClass: local-path  # Temporary: Switch back to longhorn-retain when Longhorn is fixed
    postgresql-ha:
      enabled: false  # Explicitly disable HA for single instance
    persistence:
      enabled: true
      size: 10Gi
      storageClass: local-path  # Temporary: Switch back to longhorn-retain when Longhorn is fixed
    
    # Security context for enhanced security
    podSecurityContext:
      fsGroup: 1000
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      runAsNonRoot: true
      readOnlyRootFilesystem: false
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
    
    resources:
      limits:
        cpu: 1000m
        memory: 2Gi
      requests:
        cpu: 100m
        memory: 128Mi