---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: gitea-admin-token-sync
  namespace: gitea
  labels:
    app.kubernetes.io/name: gitea-admin-token-sync
    app.kubernetes.io/component: token-management
    app.kubernetes.io/managed-by: flux
spec:
  schedule: "*/5 * * * *"  # Run every 5 minutes
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 300
      template:
        metadata:
          labels:
            app.kubernetes.io/name: gitea-admin-token-sync
        spec:
          restartPolicy: OnFailure
          serviceAccountName: gitea-runner-init
          initContainers:
          - name: wait-for-gitea
            image: curlimages/curl:latest
            command:
            - /bin/sh
            - -c
            - |
              echo "üîÑ Waiting for Gitea to be ready..."
              until curl -f -s http://gitea-http:3000/api/v1/version; do
                echo "   Gitea not ready, waiting 10 seconds..."
                sleep 10
              done
              echo "‚úÖ Gitea is ready!"
          containers:
          - name: sync-admin-token
            image: curlimages/curl:latest
            env:
            - name: GITEA_ADMIN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: gitea-admin-secrets
                  key: username
            - name: GITEA_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: gitea-admin-secrets
                  key: password
            command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "üîÑ Syncing Gitea admin token..."

              # Check if we already have a valid token in Kubernetes
              if kubectl get secret gitea-admin-api-token -n gitea >/dev/null 2>&1; then
                EXISTING_TOKEN=$(kubectl get secret gitea-admin-api-token -n gitea -o jsonpath='{.data.token}' | base64 -d)
                if [ ! -z "$EXISTING_TOKEN" ] && [ ${#EXISTING_TOKEN} -gt 10 ]; then
                  echo "‚úÖ Valid admin token already exists in Kubernetes secret"
                  exit 0
                fi
              fi

              # List existing tokens in Gitea
              echo "üìã Checking Gitea for existing tokens..."
              TOKENS=$(curl -s "http://gitea-http:3000/api/v1/users/$GITEA_ADMIN_USERNAME/tokens" \
                -u "$GITEA_ADMIN_USERNAME:$GITEA_ADMIN_PASSWORD")

              # Check if we have any tokens
              if echo "$TOKENS" | grep -q '"id":'; then
                echo "‚úÖ Found existing token in Gitea, will reuse it"
                # For now, just recreate to ensure we have the token value
                # Delete existing tokens
                TOKEN_IDS=$(echo "$TOKENS" | grep -o '"id":[0-9]*' | sed 's/"id"://g')
                for token_id in $TOKEN_IDS; do
                  curl -s -X DELETE "http://gitea-http:3000/api/v1/users/$GITEA_ADMIN_USERNAME/tokens/$token_id" \
                    -u "$GITEA_ADMIN_USERNAME:$GITEA_ADMIN_PASSWORD" >/dev/null
                done
              fi

              # Create the single admin token
              echo "üèóÔ∏è Creating admin token..."
              RESPONSE=$(curl -s -X POST "http://gitea-http:3000/api/v1/users/$GITEA_ADMIN_USERNAME/tokens" \
                -H "Content-Type: application/json" \
                -u "$GITEA_ADMIN_USERNAME:$GITEA_ADMIN_PASSWORD" \
                -d '{
                  "name": "flux-automation",
                  "scopes": ["read:activitypub", "read:issue", "write:misc", "read:notification", "read:organization", "read:package", "read:repository", "read:user", "write:admin", "write:repository", "write:user"]
                }')

              # Extract token
              ADMIN_TOKEN=$(echo "$RESPONSE" | grep -o '"sha1":"[^"]*"' | sed 's/"sha1":"//;s/"//')

              if [ -z "$ADMIN_TOKEN" ]; then
                echo "‚ùå Failed to create admin token"
                exit 1
              fi

              echo "‚úÖ Admin token created successfully"

              # Store in Kubernetes secret
              cat <<EOF | kubectl apply -f -
              apiVersion: v1
              kind: Secret
              metadata:
                name: gitea-admin-api-token
                namespace: gitea
              type: Opaque
              data:
                token: $(echo -n "$ADMIN_TOKEN" | base64)
              EOF

              echo "üíæ Admin token synced to Kubernetes secret"

              # Update the Kubernetes secret
              cat <<EOF | kubectl apply -f -
              apiVersion: v1
              kind: Secret
              metadata:
                name: gitea-admin-api-token
                namespace: gitea
              type: Opaque
              data:
                token: $(echo -n "$ADMIN_TOKEN" | base64)
              EOF

              echo "üíæ Admin token synced to secret 'gitea-admin-api-token'"

            resources:
              requests:
                memory: "32Mi"
                cpu: "50m"
              limits:
                memory: "64Mi"
                cpu: "100m"
