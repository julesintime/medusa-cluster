---
apiVersion: batch/v1
kind: Job
metadata:
  name: gitea-admin-token-init
  namespace: gitea
  labels:
    app.kubernetes.io/name: gitea-admin-token-init
    app.kubernetes.io/component: token-management
    app.kubernetes.io/managed-by: flux
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/name: gitea-admin-token-init
    spec:
      restartPolicy: OnFailure
      serviceAccountName: gitea-runner-init
      initContainers:
      - name: wait-for-gitea
        image: curlimages/curl:latest
        command:
        - /bin/sh
        - -c
        - |
          echo "ðŸ”„ Waiting for Gitea to be ready..."
          until curl -f -s http://gitea-http:3000/api/v1/version; do
            echo "   Gitea not ready, waiting 10 seconds..."
            sleep 10
          done
          echo "âœ… Gitea is ready!"
      containers:
      - name: create-admin-token
        image: bitnami/kubectl:latest
        env:
        - name: GITEA_ADMIN_USERNAME
          valueFrom:
            secretKeyRef:
              name: gitea-admin-secrets
              key: username
        - name: GITEA_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: gitea-admin-secrets
              key: password
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Checking if admin token already exists..."
          
          # Check if token secret already exists and is valid
          if kubectl get secret gitea-admin-api-token -n gitea >/dev/null 2>&1; then
            TOKEN=$(kubectl get secret gitea-admin-api-token -n gitea -o jsonpath='{.data.token}' | base64 -d 2>/dev/null || echo "")
            if [ ! -z "$TOKEN" ] && [ ${#TOKEN} -gt 10 ]; then
              echo "Valid admin API token already exists"
              exit 0
            fi
          fi
          
          echo "Generating new admin token..."
          
          # Wait for Gitea to be ready
          echo "Waiting for Gitea to be ready..."
          until kubectl get deployment gitea -n gitea >/dev/null 2>&1 && \
                [ "$(kubectl get deployment gitea -n gitea -o jsonpath='{.status.readyReplicas}')" = "1" ]; do
            echo "Waiting for Gitea deployment to be ready..."
            sleep 10
          done
          
          # Get Gitea pod
          GITEA_POD=$(kubectl get pods -n gitea -l app=gitea -o jsonpath='{.items[0].metadata.name}')
          
          if [ -z "$GITEA_POD" ]; then
            echo "No Gitea pod found"
            exit 1
          fi
          
          echo "Found Gitea pod: $GITEA_POD"
          
          # Wait for Gitea application to be ready (with timeout)
          echo "Waiting for Gitea application to be ready..."
          for i in {1..30}; do
            if kubectl exec -n gitea $GITEA_POD -- gitea admin user generate-access-token --help >/dev/null 2>&1; then
              echo "Gitea is ready!"
              break
            fi
            echo "Attempt $i/30: Waiting for Gitea application to respond..."
            sleep 10
            if [ $i -eq 30 ]; then
              echo "Timeout waiting for Gitea to be ready"
              exit 1
            fi
          done
          
          # Generate token
          echo "Generating admin token..."
          ADMIN_TOKEN=$(kubectl exec -n gitea $GITEA_POD -- gitea admin user generate-access-token \
            --username "$GITEA_ADMIN_USERNAME" \
            --token-name "flux-automation" \
            --scopes "write:admin,write:repository,write:user,read:admin,read:repository" | tr -d '\r\n' || echo "")
          
          if [ -z "$ADMIN_TOKEN" ]; then
            echo "Failed to generate admin token"
            exit 1
          fi
          
          echo "Admin token generated successfully (length: ${#ADMIN_TOKEN})"
          
          # Create/update the secret
          kubectl create secret generic gitea-admin-api-token -n gitea \
            --from-literal=token="$ADMIN_TOKEN" \
            --dry-run=client -o yaml | kubectl apply -f -
          
          echo "Admin token stored in secret 'gitea-admin-api-token'"

        resources:
          requests:
            memory: "32Mi"
            cpu: "50m"
          limits:
            memory: "64Mi"
            cpu: "100m"
