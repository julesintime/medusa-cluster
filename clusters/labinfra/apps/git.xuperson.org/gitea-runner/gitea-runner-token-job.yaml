---
apiVersion: batch/v1
kind: Job
metadata:
  name: gitea-runner-token-generator
  namespace: gitea
spec:
  ttlSecondsAfterFinished: 300  # Clean up after 5 minutes
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: gitea-runner-token-generator
    spec:
      restartPolicy: OnFailure
      serviceAccountName: gitea-runner-init
      containers:
      - name: generate-token
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Checking if runner token already exists..."
          
          # Check if token secret already exists and is valid
          if kubectl get secret gitea-runner-token -n gitea >/dev/null 2>&1; then
            TOKEN=$(kubectl get secret gitea-runner-token -n gitea -o jsonpath='{.data.token}' | base64 -d 2>/dev/null || echo "")
            if [ ! -z "$TOKEN" ] && [ ${#TOKEN} -gt 10 ]; then
              echo "Valid runner token already exists, skipping generation"
              exit 0
            fi
          fi
          
          echo "Generating new runner token..."
          
          # Wait for Gitea to be ready
          echo "Waiting for Gitea to be ready..."
          until kubectl get deployment gitea -n gitea >/dev/null 2>&1 && \
                [ "$(kubectl get deployment gitea -n gitea -o jsonpath='{.status.readyReplicas}')" = "1" ]; do
            echo "Waiting for Gitea deployment to be ready..."
            sleep 10
          done
          
          # Get Gitea pod
          GITEA_POD=$(kubectl get pods -n gitea -l app=gitea -o jsonpath='{.items[0].metadata.name}')
          
          if [ -z "$GITEA_POD" ]; then
            echo "No Gitea pod found"
            exit 1
          fi
          
          echo "Found Gitea pod: $GITEA_POD"
          
          # Wait for Gitea application to be ready (with timeout)
          echo "Waiting for Gitea application to be ready..."
          for i in {1..30}; do
            if kubectl exec -n gitea $GITEA_POD -- gitea actions generate-runner-token >/dev/null 2>&1; then
              echo "Gitea is ready!"
              break
            fi
            echo "Attempt $i/30: Waiting for Gitea application to respond..."
            sleep 10
            if [ $i -eq 30 ]; then
              echo "Timeout waiting for Gitea to be ready"
              exit 1
            fi
          done
          
          # Generate token
          echo "Generating runner token..."
          RUNNER_TOKEN=$(kubectl exec -n gitea $GITEA_POD -- gitea actions generate-runner-token | tr -d '\r\n' || echo "")
          
          if [ -z "$RUNNER_TOKEN" ]; then
            echo "Failed to generate runner token"
            exit 1
          fi
          
          echo "Runner token generated successfully (length: ${#RUNNER_TOKEN})"
          
          # Create/update the secret
          kubectl create secret generic gitea-runner-token -n gitea \
            --from-literal=token="$RUNNER_TOKEN" \
            --dry-run=client -o yaml | kubectl apply -f -
          
          echo "Runner token stored in secret 'gitea-runner-token'"
        
        resources:
          requests:
            memory: "32Mi" 
            cpu: "50m"
          limits:
            memory: "64Mi"
            cpu: "100m"
