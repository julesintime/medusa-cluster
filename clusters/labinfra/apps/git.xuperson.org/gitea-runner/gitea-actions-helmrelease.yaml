---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: gitea-actions
  namespace: gitea
spec:
  interval: 30m
  timeout: 15m
  chart:
    spec:
      chart: helm-actions
      version: "^0.2.0"
      sourceRef:
        kind: HelmRepository
        name: gitea-charts
        namespace: gitea
  
  values:
    # Enable the act runner StatefulSet
    enabled: true
    
    # StatefulSet configuration
    statefulset:
      replicas: 1
      
      # Act runner container configuration
      actRunner:
        repository: gitea/act_runner
        tag: "0.2.12"
        pullPolicy: IfNotPresent
        
        # Runner configuration
        config:
          cache:
            enabled: true
          container:
            network: bridge
          runner:
            capacity: 1
            envs: {}
            labels: []
            timeout: "3h"
      
      # Docker-in-Docker configuration  
      dind:
        repository: docker
        tag: "28.3.3-dind"
        pullPolicy: IfNotPresent
      
      # Persistence for runner data
      persistence:
        enabled: true
        size: 5Gi
        storageClass: ""  # Use default storage class
        
      # Resource limits
      resources:
        limits:
          cpu: 2000m
          memory: 2Gi
        requests:
          cpu: 100m
          memory: 256Mi
      
      # Node scheduling
      nodeSelector: {}
      tolerations: []
      affinity: {}
    
    # Use existing secret for runner token (created by job)
    existingSecret: "gitea-runner-token"
    existingSecretKey: "token"
    
    # Configure connection to Gitea instance
    giteaRootURL: "http://gitea-http.gitea.svc.cluster.local:3000"
