---
apiVersion: v1
kind: ConfigMap
metadata:
  name: hello-cicd-workflow
  namespace: gitea
  labels:
    app.kubernetes.io/name: hello-app
    app.kubernetes.io/component: cicd-workflow
    app.kubernetes.io/managed-by: flux
data:
  buildkit-ci.yml: |
    name: BuildKit CI

    on:
      push:
        branches: [ main, master ]
      pull_request:
        branches: [ main, master ]

    jobs:
      build:
        runs-on: ubuntu-latest

        steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3
          with:
            driver-opts: |
              server=tcp://buildkit.buildkit.svc.cluster.local:1234
              certs=/certs/client

        - name: Log in to registry
          uses: docker/login-action@v3
          with:
            registry: registry.k3s.internal
            username: ${{ secrets.REGISTRY_USER }}
            password: ${{ secrets.REGISTRY_PASS }}

        - name: Extract metadata
          id: meta
          uses: docker/metadata-action@v5
          with:
            images: registry.k3s.internal/hello-app
            tags: |
              type=ref,event=branch
              type=ref,event=pr
              type=sha,prefix={{branch}}-
              type=raw,value=latest,enable={{is_default_branch}}

        - name: Build and push
          uses: docker/build-push-action@v5
          with:
            context: .
            push: true
            tags: ${{ steps.meta.outputs.tags }}
            labels: ${{ steps.meta.outputs.labels }}
            cache-from: type=registry,ref=registry.k3s.internal/hello-app:cache
            cache-to: type=registry,ref=registry.k3s.internal/hello-app:cache,mode=max

        - name: Update deployment
          run: |
            echo "Build completed successfully!"
            echo "Image: ${{ steps.meta.outputs.tags }}"
            echo "This would trigger a deployment update in a real CI/CD pipeline"
