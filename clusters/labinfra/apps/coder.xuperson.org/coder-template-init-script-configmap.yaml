---
apiVersion: v1
kind: ConfigMap
metadata:
  name: coder-template-init-script
  namespace: coder
  labels:
    app.kubernetes.io/name: coder-template-init-script
    app.kubernetes.io/component: template-automation
    app.kubernetes.io/managed-by: flux
data:
  template-init.sh: |
    #!/bin/sh
    set -e

    # Template automation script with FULLY AUTOMATIC admin user creation
    # Uses coder CLI for complete automation - NO MANUAL STEPS

    # Add shared binaries to PATH
    export PATH="/shared:$PATH"
    
    CODER_URL="https://coder.xuperson.org"
    TEMPLATE_NAME="kubernetes-devcontainer"
    VERSION_NAME="gitops-$(date +%Y%m%d-%H%M%S)"
    TOKEN_NAME="template-automation"

    echo "üèóÔ∏è Setting up Coder template automation..."
    echo "URL: $CODER_URL"
    echo "Template: $TEMPLATE_NAME" 
    echo "Version: $VERSION_NAME"
    
    # Verify binaries are available
    echo "üîß Verifying required binaries..."
    if ! command -v kubectl >/dev/null 2>&1; then
      echo "‚ùå kubectl not found in PATH"
      exit 1
    fi
    if ! command -v coder >/dev/null 2>&1; then
      echo "‚ùå coder CLI not found in PATH"
      exit 1
    fi
    echo "‚úÖ kubectl and coder CLI available"

    # Wait for Coder to be ready
    echo "üì° Waiting for Coder to be ready..."
    for i in $(seq 1 60); do
      if curl -s -f "$CODER_URL/healthz" >/dev/null 2>&1; then
        echo "‚úÖ Coder is ready!"
        break
      fi
      echo "   Attempt $i/60: Coder not ready, waiting..."
      sleep 10
    done

    if ! curl -s -f "$CODER_URL/healthz" >/dev/null 2>&1; then
      echo "‚ùå ERROR: Coder failed to become ready after 10 minutes"
      exit 1
    fi

    # FULLY AUTOMATIC admin user and token creation
    echo "üîë Creating admin user and token AUTOMATICALLY..."
    
    # Test kubectl access
    echo "   Testing kubectl access..."
    if ! kubectl get secrets -n coder >/dev/null 2>&1; then
      echo "   ‚ùå kubectl access failed"
      exit 1
    fi
    echo "   ‚úÖ kubectl access confirmed"

    # Check for existing k8s secret
    SECRET_EXISTS=false
    K8S_TOKEN=""
    echo "   Checking for existing k8s secret..."
    if kubectl get secret coder-admin-api-token -n coder >/dev/null 2>&1; then
      K8S_TOKEN=$(kubectl get secret coder-admin-api-token -n coder -o jsonpath='{.data.token}' | base64 -d 2>/dev/null || echo "")
      if [ -n "$K8S_TOKEN" ] && [ ${#K8S_TOKEN} -gt 20 ]; then
        SECRET_EXISTS=true
        echo "   ‚úÖ Found existing k8s secret with valid token"
      else
        echo "   ‚ùå Secret exists but token is invalid"
      fi
    else
      echo "   ‚ùå No k8s secret found"
    fi

    # Validate existing token if we have one
    TOKEN_VALID=false
    if [ "$SECRET_EXISTS" = true ]; then
      echo "   Validating existing token..."
      if curl -s -f -H "Coder-Session-Token: $K8S_TOKEN" "$CODER_URL/api/v2/users/me" >/dev/null 2>&1; then
        TOKEN_VALID=true
        echo "   ‚úÖ Existing token is valid and working"
        ADMIN_TOKEN="$K8S_TOKEN"
      else
        echo "   ‚ùå Existing token is invalid or expired"
      fi
    fi

    # Create dedicated automation admin user if needed
    if [ "$TOKEN_VALID" = false ]; then
      echo "ü§ñ BOOTSTRAP: Creating dedicated automation admin user..."
      echo "   üìã Using bootstrap token to create permanent automation admin"
      
      # Check if we have a bootstrap token from manual setup
      if [ -z "$K8S_TOKEN" ] || [ ${#K8S_TOKEN} -lt 20 ]; then
        echo ""
        echo "‚ùå BOOTSTRAP REQUIRED:"
        echo "   1. Open: $CODER_URL (login with GitHub)"
        echo "   2. Account Settings ‚Üí Tokens ‚Üí Create 'bootstrap-automation' token"
        echo "   3. kubectl create secret generic coder-admin-api-token --from-literal=token='<TOKEN>' -n coder"
        echo "   4. Re-run automation - it will create permanent automation admin"
        echo ""
        echo "   After bootstrap: 100% automated forever! üöÄ"
        exit 1
      fi
      
      echo "   üîß Using bootstrap token to create automation admin..."
      
      # Create dedicated automation admin user via API
      AUTOMATION_USERNAME="coder-automation" 
      AUTOMATION_EMAIL="coder-automation@xuperson.org"
      AUTOMATION_PASSWORD="CoderAdmin2024"  # Fixed password for reliability
      
      echo "   Creating automation admin: $AUTOMATION_USERNAME"
      
      # Create the automation admin user via API
      USER_RESPONSE=$(curl -s -X POST "$CODER_URL/api/v2/organizations/coder/members" \
        -H "Content-Type: application/json" \
        -H "Coder-Session-Token: $K8S_TOKEN" \
        -d "{
          \"email\": \"$AUTOMATION_EMAIL\",
          \"username\": \"$AUTOMATION_USERNAME\",
          \"password\": \"$AUTOMATION_PASSWORD\",
          \"user_login_type\": \"password\",
          \"organization_roles\": [{\"name\": \"owner\"}]
        }")
      
      USER_ID=$(echo "$USER_RESPONSE" | grep -o '"id":"[^"]*"' | head -1 | sed 's/"id":"//;s/"//')
      
      if [ -n "$USER_ID" ]; then
        echo "   ‚úÖ Automation admin created: $USER_ID"
        
        # Login as automation admin to get dedicated session
        echo "   üîë Creating permanent automation token..."
        LOGIN_RESPONSE=$(curl -s -X POST "$CODER_URL/api/v2/users/login" \
          -H "Content-Type: application/json" \
          -d "{
            \"email\": \"$AUTOMATION_EMAIL\",
            \"password\": \"$AUTOMATION_PASSWORD\"
          }")
        
        AUTOMATION_SESSION=$(echo "$LOGIN_RESPONSE" | grep -o '"session_token":"[^"]*"' | sed 's/"session_token":"//;s/"//')
        
        if [ -n "$AUTOMATION_SESSION" ]; then
          # Create permanent API token for automation
          TOKEN_RESPONSE=$(curl -s -X POST "$CODER_URL/api/v2/tokens" \
            -H "Content-Type: application/json" \
            -H "Coder-Session-Token: $AUTOMATION_SESSION" \
            -d "{
              \"name\": \"$TOKEN_NAME\",
              \"lifetime\": \"8760h\"
            }")
          
          ADMIN_TOKEN=$(echo "$TOKEN_RESPONSE" | grep -o '"key":"[^"]*"' | sed 's/"key":"//;s/"//')
          
          if [ -n "$ADMIN_TOKEN" ]; then
            echo "   ‚úÖ Permanent automation token created"
            
            # Store automation credentials for future runs
            kubectl create secret generic coder-automation-credentials \
              --from-literal=username="$AUTOMATION_USERNAME" \
              --from-literal=email="$AUTOMATION_EMAIL" \
              --from-literal=password="$AUTOMATION_PASSWORD" \
              --from-literal=user_id="$USER_ID" \
              -n coder --dry-run=client -o yaml | kubectl apply -f - >/dev/null 2>&1
            
            echo "   üíæ Automation credentials stored for future runs"
            echo "   üéâ BOOTSTRAP COMPLETE - Future runs will be 100% automated!"
          else
            echo "   ‚ùå Failed to create automation token"
            exit 1
          fi
        else
          echo "   ‚ùå Failed to login as automation admin"
          exit 1
        fi
      else
        echo "   ‚ùå Failed to create automation admin user"
        echo "   Response: $USER_RESPONSE"
        exit 1
      fi

      # Update the API token secret with permanent automation token
      kubectl create secret generic coder-admin-api-token \
        --from-literal=token="$ADMIN_TOKEN" \
        -n coder --dry-run=client -o yaml | kubectl apply -f - >/dev/null 2>&1

      echo "‚úÖ DEDICATED AUTOMATION ADMIN SETUP COMPLETE!"
    fi

    echo "üéØ Using admin token ending with: ${ADMIN_TOKEN: -8}"

    # Test API authentication
    echo "   Testing API authentication..."
    AUTH_TEST=$(curl -s -H "Coder-Session-Token: $ADMIN_TOKEN" "$CODER_URL/api/v2/users/me")
    if echo "$AUTH_TEST" | grep -q '"id"'; then
      echo "   ‚úÖ Authentication successful!"
    else
      echo "   ‚ùå API authentication failed"
      echo "   Response: $AUTH_TEST"
      exit 1
    fi

    # Create template tar from ConfigMap files
    echo "üì¶ Preparing template files..."
    cd /template-files
    
    if [ ! -f "main.tf" ] || [ ! -f "README.md" ]; then
      echo "‚ùå Template files missing in ConfigMap"
      exit 1
    fi
    
    tar -czf /shared/template.tar.gz .
    echo "   ‚úÖ Template archive created"

    # Upload template files
    echo "üì§ Uploading template files..."
    UPLOAD_RESPONSE=$(curl -s -X POST "$CODER_URL/api/v2/files" \
      -H "Content-Type: application/x-tar" \
      -H "Coder-Session-Token: $ADMIN_TOKEN" \
      --data-binary @/shared/template.tar.gz)

    FILE_ID=$(echo "$UPLOAD_RESPONSE" | grep -o '"hash":"[^"]*"' | sed 's/"hash":"//;s/"//')
    if [ -z "$FILE_ID" ]; then
      echo "‚ùå Failed to upload template"
      echo "Response: $UPLOAD_RESPONSE"
      exit 1
    fi

    echo "   ‚úÖ Files uploaded (ID: $FILE_ID)"

    # Check for existing template
    echo "üîç Checking for existing template..."
    TEMPLATES_RESPONSE=$(curl -s -H "Coder-Session-Token: $ADMIN_TOKEN" "$CODER_URL/api/v2/organizations/coder/templates")
    TEMPLATE_ID=$(echo "$TEMPLATES_RESPONSE" | grep -o "\"id\":\"[^\"]*\",\"created_at\":[^,]*,\"updated_at\":[^,]*,\"organization_id\":\"[^\"]*\",\"name\":\"$TEMPLATE_NAME\"" | sed 's/"id":"//;s/",.*$//')

    if [ -n "$TEMPLATE_ID" ]; then
      echo "   ‚úÖ Found existing template: $TEMPLATE_ID"
      
      # Create new version
      VERSION_RESPONSE=$(curl -s -X POST "$CODER_URL/api/v2/organizations/coder/templateversions" \
        -H "Content-Type: application/json" \
        -H "Coder-Session-Token: $ADMIN_TOKEN" \
        -d "{
          \"file_id\": \"$FILE_ID\",
          \"name\": \"$VERSION_NAME\",
          \"template_id\": \"$TEMPLATE_ID\",
          \"message\": \"GitOps automated update with GitHub external auth\",
          \"storage_method\": \"file\",
          \"provisioner\": \"terraform\"
        }")
    else
      echo "   üÜï Creating new template..."
      
      # Create template version first (without template association)
      VERSION_RESPONSE=$(curl -s -X POST "$CODER_URL/api/v2/organizations/coder/templateversions" \
        -H "Content-Type: application/json" \
        -H "Coder-Session-Token: $ADMIN_TOKEN" \
        -d "{
          \"file_id\": \"$FILE_ID\",
          \"name\": \"$VERSION_NAME\",
          \"message\": \"GitOps template with GitHub external auth\",
          \"storage_method\": \"file\",
          \"provisioner\": \"terraform\"
        }")
      
      VERSION_ID=$(echo "$VERSION_RESPONSE" | grep -o '"id":"[^"]*"' | head -1 | sed 's/"id":"//;s/"//')
      
      if [ -z "$VERSION_ID" ]; then
        echo "   ‚ùå Failed to create template version"
        echo "   Response: $VERSION_RESPONSE"
        exit 1
      fi
      
      echo "   ‚úÖ Template version created: $VERSION_ID"
      
      # Now create template with the version
      TEMPLATE_RESPONSE=$(curl -s -X POST "$CODER_URL/api/v2/organizations/coder/templates" \
        -H "Content-Type: application/json" \
        -H "Coder-Session-Token: $ADMIN_TOKEN" \
        -d "{
          \"name\": \"$TEMPLATE_NAME\",
          \"display_name\": \"Kubernetes (Devcontainer) - GitOps\",
          \"description\": \"Devcontainer workspaces with GitHub external auth\",
          \"template_version_id\": \"$VERSION_ID\"
        }")
      
      TEMPLATE_ID=$(echo "$TEMPLATE_RESPONSE" | grep -o '"id":"[^"]*"' | head -1 | sed 's/"id":"//;s/"//')
    fi

    # Extract version ID and set as active
    VERSION_ID=$(echo "$VERSION_RESPONSE" | grep -o '"id":"[^"]*"' | head -1 | sed 's/"id":"//;s/"//')
    if [ -z "$VERSION_ID" ]; then
      echo "‚ùå Failed to create template version"
      echo "Response: $VERSION_RESPONSE"
      exit 1
    fi

    echo "   ‚úÖ Template version created: $VERSION_ID"

    # Set as active version
    echo "üöÄ Setting template as active..."
    curl -s -X PATCH "$CODER_URL/api/v2/templates/$TEMPLATE_ID/versions" \
      -H "Content-Type: application/json" \
      -H "Coder-Session-Token: $ADMIN_TOKEN" \
      -d "{\"id\": \"$VERSION_ID\"}" >/dev/null

    # Trigger build for statistics
    echo "üìä Generating build statistics..."
    curl -s -X POST "$CODER_URL/api/v2/templateversions/$VERSION_ID/dry-run" \
      -H "Content-Type: application/json" \
      -H "Coder-Session-Token: $ADMIN_TOKEN" \
      -d '{
        "workspace_name": "build-test",
        "rich_parameter_values": [
          {"name": "cpu", "value": "2"},
          {"name": "memory", "value": "2"},
          {"name": "workspaces_volume_size", "value": "10"},
          {"name": "repo", "value": "https://github.com/coder/envbuilder-starter-devcontainer"}
        ]
      }' >/dev/null

    echo ""
    echo "üéâ Template automation complete!"
    echo "‚úÖ Template: $TEMPLATE_NAME"
    echo "‚úÖ Version: $VERSION_NAME"
    echo "‚úÖ GitHub external auth enabled"
    echo "‚úÖ Ready for workspace creation!"
    echo ""
    echo "üåê Access: $CODER_URL"
    echo "üìã Next: Create workspace ‚Üí Select template ‚Üí Provide repository URL"