---
apiVersion: v1
kind: ConfigMap
metadata:
  name: coder-template-files
  namespace: coder
  labels:
    app.kubernetes.io/name: coder-template-files
    app.kubernetes.io/component: template-management
    app.kubernetes.io/managed-by: flux
data:
  main.tf: |
    terraform {
      required_providers {
        coder = {
          source  = "coder/coder"
          version = "~> 2.0"
        }
        docker = {
          source  = "kreuzwerker/docker"
          version = "~> 3.0"
        }
      }
    }

    provider "coder" {}
    provider "docker" {}

    data "coder_workspace" "me" {}

    resource "coder_agent" "main" {
      arch = "amd64"
      os   = "linux"
      startup_script = "echo 'Hello Coder!'"
    }

    resource "docker_image" "main" {
      name = "codercom/enterprise-base:ubuntu"
    }

    resource "docker_container" "workspace" {
      count = data.coder_workspace.me.start_count
      image = docker_image.main.image_id
      name  = "coder-${data.coder_workspace.me.id}"
      hostname = data.coder_workspace.me.name
      command = ["sh", "-c", coder_agent.main.init_script]
      env = ["CODER_AGENT_TOKEN=${coder_agent.main.token}"]
    }

  README.md: |
    # Simple Docker Template

    A basic Docker workspace template.

    ## Usage

    1. Create workspace
    2. Wait for container
    3. Access via Coder