# Coder Deployment on K3s - GitOps

✅ **Status**: Fully operational Coder v2.26.0 deployment with GitHub OAuth integration

🌐 **Access**: https://coder.xuperson.org

## Current Users

- **Admin**: `admin@xuperson.org` (password authentication)
- **Developer**: `julesintime@gmail.com` (GitHub OAuth authentication)

## Known Issues

⚠️ **Template Import Bug**: Coder v2.26.0 has a Terraform provisioner bug preventing template imports via CLI/API. All template files are created correctly, but Terraform reports "No configuration files" during provisioning.

**Workaround**: Templates must be created manually through the web UI or imported via alternative methods. **I will manually patch this issue.**

## Architecture

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Cloudflare    │────│    K3s Cluster   │────│   Coder App     │
│   (SSL/DNS)     │    │  (Infrastructure) │    │ (v2.26.0)       │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │
                       ┌────────┴────────┐
                       │   PostgreSQL    │
                       │   (Database)    │
                       └─────────────────┘
```

## Secrets Management

All secrets are managed through **Infisical** with automatic synchronization to Kubernetes secrets:

### 1. Database Secrets
```yaml
# Synced from Infisical (prod environment, root path)
CODER_DATABASE_USER: "coder"
CODER_DATABASE_PASSWORD: "<auto-generated>"
CODER_DATABASE_NAME: "coder"
CODER_DATABASE_URL: "postgresql://..."
```

### 2. Admin Credentials
```yaml
# Synced from Infisical (prod environment, root path)
CODER_ADMIN_EMAIL: "admin@xuperson.org"
CODER_ADMIN_PASSWORD: "<infisical-managed>"
CODER_ADMIN_USERNAME: "admin@xuperson.org"
```

### 3. GitHub OAuth Credentials
```yaml
# Synced from Infisical (prod environment, root path)
CODER_GITHUB_CLIENT_ID: "<github-oauth-app-id>"
CODER_GITHUB_CLIENT_SECRET: "<github-oauth-app-secret>"
```

## GitHub OAuth Setup

### Step 1: GitHub OAuth Application

1. **Create OAuth App** in GitHub:
   - Go to Settings → Developer settings → OAuth Apps → New OAuth App
   - **Application name**: `Coder Development Environment`
   - **Homepage URL**: `https://coder.xuperson.org`
   - **Authorization callback URL**: `https://coder.xuperson.org/api/v2/external-auth/github/callback`

2. **Copy Credentials**:
   - Client ID → Store in Infisical as `CODER_GITHUB_CLIENT_ID`
   - Client Secret → Store in Infisical as `CODER_GITHUB_CLIENT_SECRET`

### Step 2: Infisical Secret Configuration

Add these secrets to Infisical (prod environment, root path):

```bash
# GitHub OAuth credentials
infisical secrets set CODER_GITHUB_CLIENT_ID="your_github_client_id" --env=prod
infisical secrets set CODER_GITHUB_CLIENT_SECRET="your_github_client_secret" --env=prod
```

### Step 3: Coder GitHub Integration

The Coder deployment automatically configures GitHub external authentication:

```yaml
# Environment variables (auto-configured)
- name: CODER_EXTERNAL_AUTH_0_ID
  value: "github"
- name: CODER_EXTERNAL_AUTH_0_TYPE
  value: "github"
- name: CODER_EXTERNAL_AUTH_0_CLIENT_ID
  valueFrom:
    secretKeyRef:
      name: coder-github-external-auth-secrets
      key: client-id
- name: CODER_EXTERNAL_AUTH_0_CLIENT_SECRET
  valueFrom:
    secretKeyRef:
      name: coder-github-external-auth-secrets
      key: client-secret
```

## GitHub Integration for Private Repositories

### Automatic Git Authentication

When users authenticate with GitHub OAuth, Coder automatically:

1. **Stores GitHub tokens** for each user
2. **Provides git credentials** to workspaces
3. **Enables private repository cloning** in templates

### Template Integration

Templates can access GitHub credentials via:

```hcl
# Terraform template example
data "coder_external_auth" "github" {
  id = "github"
}

# Environment variables for workspace
env {
  name  = "GITHUB_TOKEN"
  value = data.coder_external_auth.github.access_token
}

env {
  name  = "GIT_USERNAME"
  value = data.coder_external_auth.github.access_token != "" ? "oauth2" : ""
}

env {
  name  = "GIT_PASSWORD"
  value = data.coder_external_auth.github.access_token
}
```

### Workspace Git Configuration

Workspaces automatically receive:

```bash
# Git credentials for private repositories
git config --global credential.helper 'store --file=/tmp/.git-credentials'
echo "https://oauth2:${GITHUB_TOKEN}@github.com" > /tmp/.git-credentials

# User information from GitHub
git config --global user.name "${GITHUB_USERNAME}"
git config --global user.email "${GITHUB_EMAIL}"
```

## User Authentication Methods

### Admin User (Password)
- **Username**: `admin@xuperson.org`
- **Password**: Managed in Infisical
- **Capabilities**: Full admin access, user management, template management

### Developer User (GitHub OAuth)
- **Email**: `julesintime@gmail.com`
- **Authentication**: GitHub OAuth
- **Capabilities**: Workspace creation, private repository access

### Adding New Users

1. **GitHub OAuth Users** (Recommended):
```bash
coder users create \
  --email "user@example.com" \
  --username "username" \
  --login-type "github"
```

2. **Password Users**:
```bash
coder users create \
  --email "user@example.com" \
  --username "username" \
  --password "secure-password"
```

## Deployment Components

### Core Services

- **Coder Server**: Main application (LoadBalancer IP: 192.168.80.105)
- **PostgreSQL**: Database backend with persistent storage
- **Nginx Ingress**: HTTPS termination and routing
- **ExternalDNS**: Automatic DNS record management

### GitOps Components

- **Flux CD**: Continuous deployment from Git
- **Infisical Operator**: Secret synchronization
- **RBAC**: Kubernetes permissions for workspace management

### Template Initialization Job

Automated setup process:

1. ✅ **Wait for Coder readiness**
2. ✅ **Create admin user** (if not exists)
3. ✅ **Generate API tokens** for automation
4. ✅ **Create GitHub OAuth user** (`julesintime@gmail.com`)
5. ❌ **Template installation** (currently broken - manual fix required)

## Manual Template Setup

Due to the current template import bug, templates must be installed manually:

### Option 1: Web UI Template Creation

1. Access https://coder.xuperson.org
2. Login as admin
3. Navigate to Templates → Create Template
4. Use the visual template builder

### Option 2: CLI Template Import (After Bug Fix)

```bash
# Initialize starter templates
coder templates init --id kubernetes .
coder templates init --id docker .

# Push templates
coder templates push kubernetes-starter
coder templates push docker-starter
```

### Available Template Types

- `docker` - Docker containers with VS Code
- `kubernetes` - Kubernetes pods with development tools
- `docker-devcontainer` - Devcontainer-based environments
- `aws-linux` - AWS EC2 instances
- `gcp-linux` - Google Cloud VMs
- `azure-linux` - Azure VMs

## Monitoring and Troubleshooting

### Check Deployment Status
```bash
export KUBECONFIG=./infrastructure/config/kubeconfig.yaml

# Check all Coder resources
kubectl get pods,svc,ingress -n coder

# Check Flux reconciliation
flux get kustomizations -A
flux get helmreleases -A

# Check Infisical secret synchronization
kubectl get infisicalsecrets -A
kubectl describe infisicalsecret coder-github-external-auth-secrets -n coder
```

### Verify GitHub Integration
```bash
# Test external auth endpoint
curl -s https://coder.xuperson.org/api/v2/external-auth/github

# Check user authentication
kubectl exec -n coder <coder-pod> -- coder users list
```

### Common Issues

1. **GitHub OAuth not working**: Check client ID/secret in Infisical
2. **Private repos failing**: Verify GitHub app permissions include repository access
3. **Templates not loading**: Known bug - use manual template creation
4. **Database connection errors**: Check PostgreSQL pod and PVC status

## Security Considerations

- **TLS Termination**: Handled by Cloudflare (A+ SSL rating)
- **Secret Management**: All secrets encrypted in Infisical
- **Network Isolation**: Workspaces deployed in dedicated namespace
- **RBAC**: Minimal permissions for service accounts
- **OAuth Scopes**: GitHub integration requests minimum required permissions

## Backup and Recovery

### Database Backup
```bash
# PostgreSQL backup (automated via cronjob - if configured)
kubectl exec -n coder postgres-pod -- pg_dump -U coder coder > backup.sql
```

### Configuration Backup
All configuration is stored in Git (GitOps) - the repository itself serves as the backup.

### Secret Backup
Secrets are managed in Infisical with built-in backup and versioning.

---

**Last Updated**: September 19, 2025  
**Coder Version**: v2.26.0  
**Maintainer**: GitOps automation with manual template patching