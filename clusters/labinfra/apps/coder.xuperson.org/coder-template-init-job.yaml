---
apiVersion: batch/v1
kind: Job
metadata:
  name: coder-template-init
  namespace: coder
  labels:
    app.kubernetes.io/name: coder-template-init
    app.kubernetes.io/component: template-automation
    app.kubernetes.io/managed-by: flux
  annotations:
    # Ensure job runs after Coder deployment is ready
    flux.weave.works/depends-on: "coder:helmrelease/coder"
spec:
  # Clean up completed jobs after 1 hour
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
        app.kubernetes.io/name: coder-template-init
        app.kubernetes.io/component: template-automation
    spec:
      serviceAccountName: coder-template-automation
      restartPolicy: OnFailure
      
      # Install kubectl and coder CLI binaries in shared volume
      initContainers:
      - name: install-binaries
        image: alpine/curl:latest
        imagePullPolicy: IfNotPresent
        command:
        - sh
        - -c
        - |
          set -e
          echo "Installing kubectl and coder CLI binaries..."
          
          # Install kubectl
          curl -L "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" -o /shared/kubectl
          chmod +x /shared/kubectl
          echo "kubectl installed successfully"
          
          # Install coder CLI directly
          CODER_VERSION="v2.26.0"
          curl -L "https://github.com/coder/coder/releases/download/${CODER_VERSION}/coder_${CODER_VERSION#v}_linux_amd64.tar.gz" | tar -xz -C /shared
          chmod +x /shared/coder
          echo "coder CLI installed successfully"
          
          # Verify installations
          /shared/kubectl version --client=true
          /shared/coder version
        volumeMounts:
        - name: shared-binaries
          mountPath: /shared
        securityContext:
          runAsNonRoot: false
          runAsUser: 0
          allowPrivilegeEscalation: false

      containers:
      - name: coder-template-setup
        image: alpine/curl:latest
        imagePullPolicy: IfNotPresent
        command: ["/scripts/template-init.sh"]
        
        env:
        - name: PATH
          value: "/shared:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
        - name: CODER_URL
          value: "https://coder.xuperson.org"
        - name: TEMPLATE_NAME
          value: "kubernetes-devcontainer"
        - name: KUBERNETES_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        
        volumeMounts:
        - name: script-volume
          mountPath: /scripts
        - name: template-files
          mountPath: /template-files
        - name: shared-binaries
          mountPath: /shared
        
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
        
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "256Mi"

      volumes:
      - name: script-volume
        configMap:
          name: coder-template-init-script
          defaultMode: 0755
      - name: template-files
        configMap:
          name: coder-template-files
      - name: shared-binaries
        emptyDir: {}

---
# Service Account for template automation
apiVersion: v1
kind: ServiceAccount
metadata:
  name: coder-template-automation
  namespace: coder
  labels:
    app.kubernetes.io/name: coder-template-automation
    app.kubernetes.io/component: template-automation
    app.kubernetes.io/managed-by: flux

---
# ClusterRole for template automation (secrets management)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: coder-template-automation
  labels:
    app.kubernetes.io/name: coder-template-automation
    app.kubernetes.io/component: template-automation
    app.kubernetes.io/managed-by: flux
rules:
# Secrets management for API token automation
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create", "patch", "update", "list", "delete"]
# ConfigMaps access for template files
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list"]
# Pods access for job execution
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]

---
# ClusterRoleBinding for template automation
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: coder-template-automation
  labels:
    app.kubernetes.io/name: coder-template-automation
    app.kubernetes.io/component: template-automation
    app.kubernetes.io/managed-by: flux
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: coder-template-automation
subjects:
- kind: ServiceAccount
  name: coder-template-automation
  namespace: coder