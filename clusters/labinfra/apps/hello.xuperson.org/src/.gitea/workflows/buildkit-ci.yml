name: BuildKit CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build with BuildKit and Push to Gitea Registry
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      run: |
        git clone https://git.xuperson.org/demo/hello-cicd-demo.git .
        ls -la

    - name: Test BuildKit connection
      run: |
        echo "Testing BuildKit connectivity..."
        echo "BuildKit client version:"
        buildctl --version
        echo "Connecting to remote BuildKit service..."
        BUILDKIT_HOST=tcp://buildkitd.gitea.svc.cluster.local:1235 buildctl debug workers

    - name: Set image metadata
      run: |
        echo "Setting up image metadata..."
        export BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
        export BUILD_REF=${GITHUB_SHA:-$(git rev-parse HEAD 2>/dev/null || echo 'local')}
        export SHORT_SHA=$(echo $BUILD_REF | cut -c1-7)
        export IMAGE_TAG="${SHORT_SHA}-$(date +%s)"
        
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
        echo "BUILD_REF=$BUILD_REF" >> $GITHUB_ENV
        echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
        
        echo "Build metadata:"
        echo "- Date: $BUILD_DATE"
        echo "- Ref: $BUILD_REF"
        echo "- Short SHA: $SHORT_SHA"
        echo "- Image Tag: $IMAGE_TAG"

    - name: Configure Gitea registry authentication
      run: |
        echo "Configuring Gitea package registry authentication..."
        mkdir -p $DOCKER_CONFIG
        echo '{"auths":{"git.xuperson.org":{"auth":"Z2l0ZWFhZG1pbjoyYXAxN0xMVkpEckNqYW50bWNCSDBkTk12ZTljZzV6emdhZHlDWWxHCg=="}},"HttpHeaders":{"User-Agent":"Docker-Client/19.03.0 (linux)"}}' > $DOCKER_CONFIG/config.json
        echo "Registry auth configured for Gitea package registry"

    - name: Build and push to Gitea Package Registry
      run: |
        echo "ðŸ“¦ Building and pushing to Gitea Package Registry..."
        BUILDKIT_HOST=tcp://buildkitd.gitea.svc.cluster.local:1235 buildctl build \
          --frontend dockerfile.v0 \
          --local context=. \
          --local dockerfile=. \
          --opt build-arg:BUILD_DATE=$BUILD_DATE \
          --opt build-arg:BUILD_REF=$BUILD_REF \
          --output type=image,name=git.xuperson.org/demo/hello-cicd-demo:$IMAGE_TAG,push=true \
          --output type=image,name=git.xuperson.org/demo/hello-cicd-demo:latest,push=true \
          --progress=plain

    - name: Validate deployment
      run: |
        echo "âœ… Build and push completed successfully!"
        echo "ï¿½ Image pushed to Gitea Package Registry:"
        echo "  - git.xuperson.org/demo/hello-cicd-demo:$IMAGE_TAG"
        echo "  - git.xuperson.org/demo/hello-cicd-demo:latest"
        echo ""
        echo "ðŸš€ Flux ImageRepository will detect the new image and update deployment automatically!"