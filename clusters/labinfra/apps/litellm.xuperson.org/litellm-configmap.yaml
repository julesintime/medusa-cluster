apiVersion: v1
kind: ConfigMap
metadata:
  name: litellm-config-file
  namespace: litellm
data:
  config.yaml: |
    # Advanced routing: specific models, wildcards, and default rotation with fallbacks
    model_list: 
      
      # === SPECIFIC MODEL ROUTING ===
      # Direct routing to specific models when requested by exact name
      
      # Gemini 2.5 Pro - Enhanced thinking and reasoning
      - model_name: "gemini-2.5-pro"
        litellm_params:
          model: "gemini/gemini-2.5-pro"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 5
          tpm: 250000
        model_info:
          health_check_timeout: 15               # Extended timeout for large models
          cooldown_time: 1800                    # 30min cooldown for quota exhaustion
      - model_name: "gemini-2.5-pro"
        litellm_params:
          model: "gemini/gemini-2.5-pro"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 5
          tpm: 250000
        model_info:
          health_check_timeout: 15
          cooldown_time: 1800
          
      # Gemini 2.5 Flash - Adaptive thinking, cost efficient
      - model_name: "gemini-2.5-flash"
        litellm_params:
          model: "gemini/gemini-2.5-flash"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 10
          tpm: 250000
        model_info:
          health_check_timeout: 10
          cooldown_time: 1200                    # 20min cooldown for quota issues
      - model_name: "gemini-2.5-flash"
        litellm_params:
          model: "gemini/gemini-2.5-flash"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 10
          tpm: 250000
        model_info:
          health_check_timeout: 10
          cooldown_time: 1200
          
      # Gemini 2.5 Flash-Lite - Most cost-efficient
      - model_name: "gemini-2.5-flash-lite"
        litellm_params:
          model: "gemini/gemini-2.5-flash-lite"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 15
          tpm: 250000
        model_info:
          health_check_timeout: 8
          cooldown_time: 900                     # 15min cooldown
      - model_name: "gemini-2.5-flash-lite"
        litellm_params:
          model: "gemini/gemini-2.5-flash-lite"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 15
          tpm: 250000
        model_info:
          health_check_timeout: 8
          cooldown_time: 900
          
      # Gemini 2.0 Flash - High throughput
      - model_name: "gemini-2.0-flash"
        litellm_params:
          model: "gemini/gemini-2.0-flash"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 15
          tpm: 1000000
        model_info:
          health_check_timeout: 8
          cooldown_time: 600                     # 10min cooldown
      - model_name: "gemini-2.0-flash"
        litellm_params:
          model: "gemini/gemini-2.0-flash"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 15
          tpm: 1000000
        model_info:
          health_check_timeout: 8
          cooldown_time: 600
          
      # Gemini 2.0 Flash Experimental - Higher rate limits (correct model ID)
      - model_name: "gemini-2.0-flash-lite"
        litellm_params:
          model: "gemini/gemini-2.0-flash-exp"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 15
          tpm: 1000000
        model_info:
          health_check_timeout: 8
          cooldown_time: 600                     # 10min cooldown
      - model_name: "gemini-2.0-flash-lite"
        litellm_params:
          model: "gemini/gemini-2.0-flash-exp"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 15
          tpm: 1000000
        model_info:
          health_check_timeout: 8
          cooldown_time: 600
          
          
      # === WILDCARD ROUTING ===
      # Handles any gemini/* model requests (e.g., gemini/gemini-2.5-pro, gemini/new-model)
      - model_name: "gemini/*"
        litellm_params:
          model: "gemini/*"
          api_key: "os.environ/GEMINI_KEY_1"
      - model_name: "gemini/*"
        litellm_params:
          model: "gemini/*"
          api_key: "os.environ/GEMINI_KEY_2"
          
      # === DEFAULT ROTATION POOL ===
      # "gpt-4" and catch-all models rotate through all available models
      
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.5-pro"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 5
          tpm: 250000
        model_info:
          health_check_timeout: 15
          cooldown_time: 1800
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.5-pro"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 5
          tpm: 250000
        model_info:
          health_check_timeout: 15
          cooldown_time: 1800
          
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.5-flash"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 10
          tpm: 250000
        model_info:
          health_check_timeout: 10
          cooldown_time: 1200
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.5-flash"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 10
          tpm: 250000
        model_info:
          health_check_timeout: 10
          cooldown_time: 1200
          
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.5-flash-lite"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 15
          tpm: 250000
        model_info:
          health_check_timeout: 8
          cooldown_time: 900
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.5-flash-lite"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 15
          tpm: 250000
        model_info:
          health_check_timeout: 8
          cooldown_time: 900
          
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.0-flash"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 15
          tpm: 1000000
        model_info:
          health_check_timeout: 8
          cooldown_time: 600
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.0-flash"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 15
          tpm: 1000000
        model_info:
          health_check_timeout: 8
          cooldown_time: 600
          
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.0-flash-exp"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 15
          tpm: 1000000
        model_info:
          health_check_timeout: 8
          cooldown_time: 600
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.0-flash-exp"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 15
          tpm: 1000000
        model_info:
          health_check_timeout: 8
          cooldown_time: 600
          
    
    # Advanced router settings with proper cooldown and health checking
    router_settings:
      routing_strategy: least-busy             # Route to least busy deployment
      num_retries: 3                           # Conservative retries to avoid cycling
      timeout: 60                              # Request timeout
      retry_after: 2                           # 2s delay between retries
      cooldown_time: 300                       # 5min default cooldown for failed models
      allowed_fails: 2                         # Cooldown after 2 failures per minute
      
      # Enable intelligent routing and health monitoring
      enable_pre_call_checks: true             # CRITICAL: Skip unhealthy deployments
      disable_spend_logs: false                # Keep cost tracking
      
      # Error-specific retry policies (minimize retries for quota issues)
      retry_policy:
        "RateLimitErrorRetries": 2             # Limited retries for rate limits
        "ResourceExhaustedErrorRetries": 0     # NO retries for quota exhaustion
        "ServiceUnavailableErrorRetries": 1    # Minimal retries for service issues
        "TimeoutErrorRetries": 2               # Retry timeouts
        "BadRequestErrorRetries": 0            # No retries for bad requests
        "AuthenticationErrorRetries": 0        # No retries for auth errors
        
      # Error-specific cooldown policies (long cooldowns for quota issues)
      allowed_fails_policy:
        "RateLimitErrorAllowedFails": 3        # Cool down after 3 rate limit errors
        "ResourceExhaustedErrorAllowedFails": 1 # Cool down immediately on quota exhaustion
        "ServiceUnavailableErrorAllowedFails": 2 # Cool down after 2 service errors
        "TimeoutErrorAllowedFails": 5          # More lenient for timeouts
        "BadRequestErrorAllowedFails": 1       # Cool down immediately for bad requests
        "AuthenticationErrorAllowedFails": 1   # Cool down immediately for auth errors
    
    # Advanced fallback configuration
    litellm_settings:
      # Specific model fallbacks - fall back to gpt-4 rotation pool (tool-calling models only)
      fallbacks: 
        - "gemini-2.5-pro": ["gpt-4"]
        - "gemini-2.5-flash": ["gpt-4"] 
        - "gemini-2.5-flash-lite": ["gpt-4"]
        - "gemini-2.0-flash": ["gpt-4"]
        - "gemini-2.0-flash-lite": ["gpt-4"]
        - "gemini/*": ["gpt-4"]                  # Wildcard fallback to rotation
      
      # Default fallback for any unrecognized model
      default_fallbacks: ["gpt-4"]
      
      # Fallback error conditions - trigger fallbacks on quota/rate limit errors
      context_window_fallbacks: [
        {"RateLimitError": ["gpt-4"]},
        {"ResourceExhaustedError": ["gpt-4"]}, 
        {"ServiceUnavailableError": ["gpt-4"]},
        {"QuotaExceededError": ["gpt-4"]}
      ]
      
      # General settings
      success_callback: ["langfuse"]           # Optional: track successful requests
      failure_callback: ["langfuse"]           # Optional: track failed requests
      drop_params: true                        # Drop unsupported parameters
      set_verbose: false                       # Reduce logging noise
      
      # Enhanced error handling and performance settings
      request_timeout: 60                      # Request timeout
      max_retries: 3                           # Conservative max retries
      fallback_immediately_on_429: true       # Immediate fallback on rate limits
      fallback_immediately_on_503: true       # Immediate fallback on service unavailable
      
    # Background health monitoring and performance optimization
    general_settings:
      background_health_checks: true          # Enable proactive health monitoring
      health_check_interval: 120              # Check health every 2 minutes
      health_check_timeout: 10                # 10s timeout for health checks