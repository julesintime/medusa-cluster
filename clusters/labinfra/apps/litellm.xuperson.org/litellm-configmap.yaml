apiVersion: v1
kind: ConfigMap
metadata:
  name: litellm-config-file
  namespace: litellm
data:
  config.yaml: |
    # Advanced routing: specific models, wildcards, and default rotation with fallbacks
    model_list: 
      
      # === SPECIFIC MODEL ROUTING ===
      # Direct routing to specific models when requested by exact name
      
      # Gemini 2.5 Pro - Enhanced thinking and reasoning
      - model_name: "gemini-2.5-pro"
        litellm_params:
          model: "gemini/gemini-2.5-pro"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 5
          tpm: 250000
        model_info:
          health_check_timeout: 15               # Extended timeout for large models
          cooldown_time: 180                     # 3min cooldown for daily quota rotation
      - model_name: "gemini-2.5-pro"
        litellm_params:
          model: "gemini/gemini-2.5-pro"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 5
          tpm: 250000
        model_info:
          health_check_timeout: 15
          cooldown_time: 180
          
      # Gemini 2.5 Flash - Adaptive thinking, cost efficient
      - model_name: "gemini-2.5-flash"
        litellm_params:
          model: "gemini/gemini-2.5-flash"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 10
          tpm: 250000
        model_info:
          health_check_timeout: 10
          cooldown_time: 120                    # 20min cooldown for quota issues
      - model_name: "gemini-2.5-flash"
        litellm_params:
          model: "gemini/gemini-2.5-flash"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 10
          tpm: 250000
        model_info:
          health_check_timeout: 10
          cooldown_time: 120
          
      # Gemini 2.5 Flash-Lite - Most cost-efficient
      - model_name: "gemini-2.5-flash-lite"
        litellm_params:
          model: "gemini/gemini-2.5-flash-lite"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 15
          tpm: 250000
        model_info:
          health_check_timeout: 8
          cooldown_time: 90                     # 15min cooldown
      - model_name: "gemini-2.5-flash-lite"
        litellm_params:
          model: "gemini/gemini-2.5-flash-lite"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 15
          tpm: 250000
        model_info:
          health_check_timeout: 8
          cooldown_time: 90
          
      # Gemini 2.0 Flash - High throughput
      - model_name: "gemini-2.0-flash"
        litellm_params:
          model: "gemini/gemini-2.0-flash"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 15
          tpm: 1000000
        model_info:
          health_check_timeout: 8
          cooldown_time: 60                     # 10min cooldown
      - model_name: "gemini-2.0-flash"
        litellm_params:
          model: "gemini/gemini-2.0-flash"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 15
          tpm: 1000000
        model_info:
          health_check_timeout: 8
          cooldown_time: 60
          
      # Gemini 2.0 Flash Experimental - Higher rate limits (correct model ID)
      - model_name: "gemini-2.0-flash-lite"
        litellm_params:
          model: "gemini/gemini-2.0-flash-exp"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 15
          tpm: 1000000
        model_info:
          health_check_timeout: 8
          cooldown_time: 60                     # 10min cooldown
      - model_name: "gemini-2.0-flash-lite"
        litellm_params:
          model: "gemini/gemini-2.0-flash-exp"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 15
          tpm: 1000000
        model_info:
          health_check_timeout: 8
          cooldown_time: 60
          
          
      # === WILDCARD ROUTING (Gemini only - excludes Gemma) ===
      # Only matches gemini-2.x models, NOT gemma models (no tool calling support)
      - model_name: "gemini-2*"
        litellm_params:
          model: "gemini/gemini-2.5-flash"
          api_key: "os.environ/GEMINI_KEY_1"
        model_info:
          health_check_timeout: 10
          cooldown_time: 60                     # 5min cooldown for wildcards
      - model_name: "gemini-2*"
        litellm_params:
          model: "gemini/gemini-2.5-flash"
          api_key: "os.environ/GEMINI_KEY_2"
        model_info:
          health_check_timeout: 10
          cooldown_time: 60
          
      # === DEFAULT ROTATION POOL ===
      # "gpt-4" and catch-all models rotate through all available models
      
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.5-pro"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 5
          tpm: 250000
        model_info:
          health_check_timeout: 15
          cooldown_time: 180
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.5-pro"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 5
          tpm: 250000
        model_info:
          health_check_timeout: 15
          cooldown_time: 180
          
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.5-flash"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 10
          tpm: 250000
        model_info:
          health_check_timeout: 10
          cooldown_time: 120
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.5-flash"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 10
          tpm: 250000
        model_info:
          health_check_timeout: 10
          cooldown_time: 120
          
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.5-flash-lite"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 15
          tpm: 250000
        model_info:
          health_check_timeout: 8
          cooldown_time: 90
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.5-flash-lite"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 15
          tpm: 250000
        model_info:
          health_check_timeout: 8
          cooldown_time: 90
          
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.0-flash"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 15
          tpm: 1000000
        model_info:
          health_check_timeout: 8
          cooldown_time: 60
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.0-flash"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 15
          tpm: 1000000
        model_info:
          health_check_timeout: 8
          cooldown_time: 60
          
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.0-flash-exp"
          api_key: "os.environ/GEMINI_KEY_1"
          rpm: 15
          tpm: 1000000
        model_info:
          health_check_timeout: 8
          cooldown_time: 60
      - model_name: "gpt-4"
        litellm_params:
          model: "gemini/gemini-2.0-flash-exp"
          api_key: "os.environ/GEMINI_KEY_2"
          rpm: 15
          tpm: 1000000
        model_info:
          health_check_timeout: 8
          cooldown_time: 60
          
    
    # Optimized router settings for daily quota management
    router_settings:
      routing_strategy: usage-based-routing-v2 # Route to deployments with lowest usage
      num_retries: 2                           # Minimal retries to prevent quota waste
      timeout: 45                              # Shorter timeout for faster failover
      retry_after: 1                           # 1s delay between retries
      cooldown_time: 180                       # 3min default cooldown for daily quotas
      allowed_fails: 1                         # Quick cooldown after single failure
      
      # Enable intelligent routing and health monitoring
      enable_pre_call_checks: true             # CRITICAL: Skip unhealthy deployments
      disable_spend_logs: false                # Keep cost tracking
      
      # Error-specific retry policies (optimized for daily quota rotation)
      retry_policy:
        "RateLimitErrorRetries": 1             # Single retry for rate limits
        "ResourceExhaustedErrorRetries": 0     # NO retries for quota exhaustion
        "ServiceUnavailableErrorRetries": 1    # Single retry for service issues
        "TimeoutErrorRetries": 2               # Retry timeouts twice
        "BadRequestErrorRetries": 0            # No retries for bad requests (Gemma models)
        "AuthenticationErrorRetries": 0        # No retries for auth errors
        
      # Error-specific cooldown policies (short cooldowns for daily quota cycling)
      allowed_fails_policy:
        "RateLimitErrorAllowedFails": 2        # Cool down after 2 rate limit errors
        "ResourceExhaustedErrorAllowedFails": 1 # Cool down immediately on quota exhaustion
        "ServiceUnavailableErrorAllowedFails": 1 # Cool down after 1 service error
        "TimeoutErrorAllowedFails": 3          # Allow more timeouts
        "BadRequestErrorAllowedFails": 0       # Immediate permanent cooldown for Gemma
        "AuthenticationErrorAllowedFails": 0   # Immediate permanent cooldown for auth
    
    # Advanced fallback configuration
    litellm_settings:
      # Specific model fallbacks - fall back to gpt-4 rotation pool (tool-calling models only)
      fallbacks: 
        - "gemini-2.5-pro": ["gpt-4"]
        - "gemini-2.5-flash": ["gpt-4"] 
        - "gemini-2.5-flash-lite": ["gpt-4"]
        - "gemini-2.0-flash": ["gpt-4"]
        - "gemini-2.0-flash-lite": ["gpt-4"]
        - "gemini/*": ["gpt-4"]                  # Wildcard fallback to rotation
      
      # Default fallback for any unrecognized model
      default_fallbacks: ["gpt-4"]
      
      # Fallback error conditions - trigger fallbacks on quota/rate limit errors
      context_window_fallbacks: [
        {"RateLimitError": ["gpt-4"]},
        {"ResourceExhaustedError": ["gpt-4"]}, 
        {"ServiceUnavailableError": ["gpt-4"]},
        {"QuotaExceededError": ["gpt-4"]}
      ]
      
      # General settings
      success_callback: ["langfuse"]           # Optional: track successful requests
      failure_callback: ["langfuse"]           # Optional: track failed requests
      drop_params: true                        # Drop unsupported parameters
      set_verbose: false                       # Reduce logging noise
      
      # Enhanced error handling optimized for quota management
      request_timeout: 45                      # Shorter timeout for faster rotation
      max_retries: 2                           # Minimal retries to preserve quotas
      fallback_immediately_on_429: true       # Immediate fallback on rate limits
      fallback_immediately_on_503: true       # Immediate fallback on service unavailable
      
    # Background health monitoring and daily quota optimization
    general_settings:
      background_health_checks: true          # Enable proactive health monitoring
      health_check_interval: 300              # Check health every 5 minutes (less frequent)
      health_check_timeout: 8                 # 8s timeout for health checks
      
      # Daily budget management for optimal quota distribution
      proxy_budget_rescheduler_min_time: 60   # Check budget resets every minute
      proxy_budget_rescheduler_max_time: 300  # Max 5min between budget checks