---
apiVersion: batch/v1
kind: Job
metadata:
  name: medusa-docker-build
  namespace: medusa
spec:
  template:
    spec:
      restartPolicy: Never
      serviceAccountName: medusa
      containers:
      - name: build-and-push
        image: docker:dind
        command:
        - sh
        - -c
        - |
          # Start Docker daemon
          dockerd &
          sleep 10
          
          # Install git
          apk add --no-cache git
          
          # Clone repository
          git clone https://git.xuperson.org/helloroot/medusa-app.git /workspace
          cd /workspace
          
          # Get admin credentials
          GITEA_USER=$(cat /etc/gitea-admin/username)
          GITEA_PASS=$(cat /etc/gitea-admin/password)
          
          # Login to registry
          echo "$GITEA_PASS" | docker login git.xuperson.org -u "$GITEA_USER" --password-stdin
          
          # Get commit SHA for tagging
          COMMIT_SHA=$(git rev-parse --short HEAD)
          IMAGE_TAG="main-${COMMIT_SHA}"
          
          # Build and push image with no cache
          docker build --no-cache -t git.xuperson.org/helloroot/medusa-app:${IMAGE_TAG} .
          docker push git.xuperson.org/helloroot/medusa-app:${IMAGE_TAG}
          
          # Also tag as latest
          docker tag git.xuperson.org/helloroot/medusa-app:${IMAGE_TAG} git.xuperson.org/helloroot/medusa-app:latest
          docker push git.xuperson.org/helloroot/medusa-app:latest
          
          echo "Successfully built and pushed: git.xuperson.org/helloroot/medusa-app:${IMAGE_TAG}"
        securityContext:
          privileged: true
        volumeMounts:
        - name: gitea-admin-secret
          mountPath: /etc/gitea-admin
          readOnly: true
      volumes:
      - name: gitea-admin-secret
        secret:
          secretName: gitea-admin-secrets
          defaultMode: 0400