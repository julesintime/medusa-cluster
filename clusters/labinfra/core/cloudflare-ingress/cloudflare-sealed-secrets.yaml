---
# Option 1: Service Token Authentication (Simple approach)
# Create this secret manually or via sealed-secrets/external-secrets
apiVersion: v1
kind: Secret
metadata:
  name: infisical-service-token
  namespace: cloudflare
type: Opaque
stringData:
  # Only use the access token portion (before the last '.')
  serviceToken: "REPLACE_WITH_ACTUAL_SERVICE_TOKEN"  # TODO: Replace with actual Infisical service token
---
# Option 2: Service Account for Kubernetes Native Auth (Recommended)
apiVersion: v1
kind: ServiceAccount
metadata:
  name: infisical-auth
  namespace: cloudflare
---
# Token secret for the service account (required for token retrieval)
apiVersion: v1
kind: Secret
type: kubernetes.io/service-account-token
metadata:
  name: infisical-auth-token
  namespace: cloudflare
  annotations:
    kubernetes.io/service-account.name: "infisical-auth"
---
# ClusterRoleBinding for token review permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: infisical-cloudflare-auth-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:auth-delegator
subjects:
  - kind: ServiceAccount
    name: infisical-auth
    namespace: cloudflare
---
# InfisicalSecret using Service Token (Option 1)
apiVersion: secrets.infisical.com/v1alpha1
kind: InfisicalSecret
metadata:
  name: cloudflare-secrets-service-token
  namespace: cloudflare
spec:
  hostAPI: https://app.infisical.com/api
  resyncInterval: 60  # Sync every minute
  projectId: "REPLACE_WITH_PROJECT_ID"  # TODO: Update with actual project ID from Infisical
  environment: prod
  secretPath: "/cloudflare"
  authentication:
    serviceToken:
      serviceTokenSecretReference:
        secretName: infisical-service-token
        secretNamespace: cloudflare
        keyName: serviceToken  # Key name in the secret
  managedKubeSecretReferences:
    - secretName: cloudflare-secrets
      secretNamespace: cloudflare
      creationPolicy: "Orphan"
---
# InfisicalSecret using Kubernetes Auth (Option 2 - Recommended)
apiVersion: secrets.infisical.com/v1alpha1
kind: InfisicalSecret
metadata:
  name: cloudflare-secrets-kubernetes-auth
  namespace: cloudflare
spec:
  hostAPI: https://app.infisical.com/api
  resyncInterval: 60  # Sync every minute
  authentication:
    kubernetesAuth:
      identityId: "REPLACE_WITH_MACHINE_IDENTITY_ID"  # TODO: Update with actual Machine Identity ID
      serviceAccountRef:
        name: infisical-auth
        namespace: cloudflare
      secretsScope:
        projectSlug: "your-project-slug"  # TODO: Update with actual project slug
        envSlug: prod
        secretsPath: "/cloudflare"
        recursive: true
  managedKubeSecretReferences:
    - secretName: cloudflare-secrets-k8s
      secretNamespace: cloudflare
      creationPolicy: "Orphan"
