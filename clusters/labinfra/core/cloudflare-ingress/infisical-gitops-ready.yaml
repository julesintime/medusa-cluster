# GitOps Configuration for Infisical Cloudflare Secrets
#
# This file demonstrates how to configure Infisical for CloudFlare secrets
# in a GitOps environment using Kubernetes Native Authentication.
#
# Prerequisites:
# 1. Machine Identity created in Infisical with Kubernetes Auth configured
# 2. Token Reviewer JWT configured in Infisical Machine Identity settings
# 3. Cloudflare secrets stored in Infisical under /cloudflare path

apiVersion: v1
kind: ServiceAccount
metadata:
  name: infisical-auth
  namespace: cloudflare
  labels:
    app.kubernetes.io/name: infisical
    app.kubernetes.io/component: authentication
---
apiVersion: v1
kind: Secret
type: kubernetes.io/service-account-token
metadata:
  name: infisical-auth-token
  namespace: cloudflare
  annotations:
    kubernetes.io/service-account.name: "infisical-auth"
  labels:
    app.kubernetes.io/name: infisical
    app.kubernetes.io/component: authentication
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: infisical-cloudflare-auth-binding
  labels:
    app.kubernetes.io/name: infisical
    app.kubernetes.io/component: authentication
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:auth-delegator
subjects:
  - kind: ServiceAccount
    name: infisical-auth
    namespace: cloudflare
---
# Configurable via Kustomize overlays or environment-specific values
apiVersion: v1
kind: ConfigMap
metadata:
  name: infisical-cloudflare-config
  namespace: cloudflare
  labels:
    app.kubernetes.io/name: infisical
    app.kubernetes.io/component: configuration
data:
  # Update these values for your environment
  machine-identity-id: "REPLACE_WITH_MACHINE_IDENTITY_ID"
  project-slug: "your-project-slug"
  environment: "prod"
  secret-path: "/cloudflare"
  resync-interval: "60"
---
apiVersion: secrets.infisical.com/v1alpha1
kind: InfisicalSecret
metadata:
  name: cloudflare-secrets
  namespace: cloudflare
  labels:
    app.kubernetes.io/name: infisical
    app.kubernetes.io/component: secret-sync
spec:
  hostAPI: https://app.infisical.com/api
  resyncInterval: 60
  authentication:
    kubernetesAuth:
      identityId: "REPLACE_WITH_MACHINE_IDENTITY_ID"  # From configmap or overlay
      serviceAccountRef:
        name: infisical-auth
        namespace: cloudflare
      secretsScope:
        projectSlug: "your-project-slug"  # From configmap or overlay
        envSlug: "prod"
        secretsPath: "/cloudflare"
        recursive: true
  managedKubeSecretReferences:
    - secretName: cloudflare-secrets
      secretNamespace: cloudflare
      creationPolicy: "Orphan"
      template:
        includeAllSecrets: true
        data:
          # Map Infisical secret keys to Kubernetes secret keys if needed
          CLOUDFLARE_API_TOKEN: "{{ .CLOUDFLARE_API_TOKEN.Value }}"
          CLOUDFLARE_EMAIL: "{{ .CLOUDFLARE_EMAIL.Value }}"
          CLOUDFLARE_ZONE_ID: "{{ .CLOUDFLARE_ZONE_ID.Value }}"
