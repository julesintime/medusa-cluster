apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: archon
  namespace: archon
  labels:
    app.kubernetes.io/name: archon
    app.kubernetes.io/part-of: archon-cluster
  annotations:
    external-dns.alpha.kubernetes.io/hostname: "archon.xuperson.org"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # WebSocket support for Socket.IO
    nginx.ingress.kubernetes.io/websocket-services: "archon-server"
    nginx.ingress.kubernetes.io/proxy-set-headers: "ingress-nginx/proxy-headers"
    # API routing
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/configuration-snippet: |
      rewrite ^/api/(.*)$ /api/$1 break;
      rewrite ^/mcp/(.*)$ /mcp/$1 break;
      rewrite ^/agents/(.*)$ /agents/$1 break;
spec:
  ingressClassName: nginx
  rules:
  - host: archon.xuperson.org
    http:
      paths:
      # Frontend (default route)
      - path: /
        pathType: Prefix
        backend:
          service:
            name: archon-frontend
            port:
              number: 3737
      # API routes to server
      - path: /api(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: archon-server
            port:
              number: 8181
      # Socket.IO routes to server
      - path: /socket.io(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: archon-server
            port:
              number: 8181
      # MCP routes
      - path: /mcp(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: archon-mcp
            port:
              number: 8051
      # Agents routes
      - path: /agents(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: archon-agents
            port:
              number: 8052