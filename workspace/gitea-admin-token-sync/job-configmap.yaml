apiVersion: v1
kind: ConfigMap
metadata:
  name: gitea-token-sync-script
  namespace: gitea
data:
  sync.sh: |
    #!/bin/sh
    set -e

    echo "üîÑ Syncing Gitea admin API token..."

    # Get admin credentials from Kubernetes secrets
    ADMIN_USER=$(kubectl get secret gitea-admin-secrets -n gitea -o jsonpath='{.data.username}' | base64 -d)
    ADMIN_PASS=$(kubectl get secret gitea-admin-secrets -n gitea -o jsonpath='{.data.password}' | base64 -d)

    echo "üì° Testing Gitea API connection..."
    until curl -s -f -u "$ADMIN_USER:$ADMIN_PASS" "http://gitea-http.gitea.svc.cluster.local:3000/api/v1/version" >/dev/null; do
      echo "   Gitea API not ready, waiting 5 seconds..."
      sleep 5
    done
    echo "‚úÖ Gitea API is accessible"

    # List all existing tokens in Gitea
    echo "üìã Listing all existing admin tokens in Gitea..."
    TOKENS_RESPONSE=$(curl -s -u "$ADMIN_USER:$ADMIN_PASS" "http://gitea-http.gitea.svc.cluster.local:3000/api/v1/users/$ADMIN_USER/tokens")

    if [ $? -ne 0 ] || [ -z "$TOKENS_RESPONSE" ]; then
      echo "‚ùå Failed to fetch tokens from Gitea API"
      exit 1
    fi

    # Parse and list tokens
    TOKEN_NAMES=$(echo "$TOKENS_RESPONSE" | grep -o '"name":"[^"]*"' | sed 's/"name":"//;s/"//' || echo "")
    if [ -z "$TOKEN_NAMES" ]; then
      echo "   No existing tokens found."
    else
      echo "   Existing tokens:"
      for name in $TOKEN_NAMES; do
        echo "     - $name"
      done
    fi

    # SYNC Logic: Check existing K8s secret first
    if kubectl get secret gitea-admin-api-token -n gitea >/dev/null 2>&1; then
      EXISTING_TOKEN=$(kubectl get secret gitea-admin-api-token -n gitea -o jsonpath='{.data.token}' | base64 -d 2>/dev/null || echo "")
      
      if [ ! -z "$EXISTING_TOKEN" ] && [ ${#EXISTING_TOKEN} -eq 40 ]; then
        # Test if existing token still works
        if curl -s -f -H "Authorization: token $EXISTING_TOKEN" "http://gitea-http.gitea.svc.cluster.local:3000/api/v1/user" >/dev/null; then
          echo "‚úÖ Existing admin token is valid and working (length: ${#EXISTING_TOKEN})"
          echo "üîÑ SYNC: No update needed"
          exit 0
        else
          echo "‚ö†Ô∏è  Existing token is invalid, needs update"
        fi
      else
        echo "‚ö†Ô∏è  Invalid token in K8s secret, needs update"
      fi
    else
      echo "üìã No admin token secret exists, will create"
    fi

    # Clean up existing tokens in Gitea to ensure only one exists
    TOKEN_IDS=$(echo "$TOKENS_RESPONSE" | grep -o '"id":[0-9]*' | sed 's/"id"://' || echo "")

    if [ ! -z "$TOKEN_IDS" ]; then
      echo "üßπ Cleaning up existing tokens to ensure single token..."
      for token_id in $TOKEN_IDS; do
        echo "   Deleting token ID: $token_id"
        curl -s -X DELETE "http://gitea-http.gitea.svc.cluster.local:3000/api/v1/users/$ADMIN_USER/tokens/$token_id" \
          -u "$ADMIN_USER:$ADMIN_PASS" >/dev/null
      done
    fi

    # Create new admin token
    echo "üèóÔ∏è Creating new admin API token..."
    RESPONSE=$(curl -s -X POST "http://gitea-http.gitea.svc.cluster.local:3000/api/v1/users/$ADMIN_USER/tokens" \
      -H "Content-Type: application/json" \
      -u "$ADMIN_USER:$ADMIN_PASS" \
      -d '{
        "name": "flux-automation", 
        "scopes": ["all"]
      }')

    # Extract token
    ADMIN_TOKEN=$(echo "$RESPONSE" | grep -o '"sha1":"[a-f0-9]*"' | sed 's/"sha1":"//;s/"//')

    if [ -z "$ADMIN_TOKEN" ] || [ ${#ADMIN_TOKEN} -ne 40 ]; then
      echo "‚ùå Failed to create admin token"
      echo "Response: $RESPONSE"
      exit 1
    fi

    echo "‚úÖ Admin token created (length: ${#ADMIN_TOKEN})"

    # Test the new token
    if ! curl -s -f -H "Authorization: token $ADMIN_TOKEN" "http://gitea-http.gitea.svc.cluster.local:3000/api/v1/user" >/dev/null; then
      echo "‚ùå New token failed validation"
      exit 1
    fi
    echo "‚úÖ Token validation successful"

    # SYNC: Store/Update in Kubernetes secret
    kubectl create secret generic gitea-admin-api-token \
      --from-literal=token="$ADMIN_TOKEN" \
      --namespace=gitea \
      --dry-run=client -o yaml | kubectl apply -f -

    echo "üíæ SYNC: Admin token synced to secret 'gitea-admin-api-token'"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: gitea-admin-token-sync-configmap
  namespace: gitea
spec:
  template:
    spec:
      serviceAccountName: gitea-token-sync-sa
      containers:
      - name: sync
        image: bitnami/kubectl:latest  # Base image with kubectl
        command: ["/bin/sh", "/scripts/sync.sh"]
        volumeMounts:
        - name: script
          mountPath: /scripts
          readOnly: true
      volumes:
      - name: script
        configMap:
          name: gitea-token-sync-script
          defaultMode: 0755
      restartPolicy: Never
  backoffLimit: 3
