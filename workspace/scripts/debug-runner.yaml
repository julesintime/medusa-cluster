apiVersion: v1
kind: Pod
metadata:
  name: debug-runner
  namespace: gitea
spec:
  serviceAccountName: gitea-runner-init
  restartPolicy: Never
  initContainers:
  - name: install-kubectl
    image: bitnami/kubectl:latest
    command:
    - sh
    - -c
    - cp /opt/bitnami/kubectl/bin/kubectl /shared/kubectl && chmod +x /shared/kubectl
    volumeMounts:
    - name: kubectl-binary
      mountPath: /shared
  containers:
  - name: debug
    image: alpine/curl:latest
    command:
    - sh
    - -c
    - |
      echo "🔍 Testing kubectl access..."
      echo "PATH: $PATH"
      echo "Kubectl binary:"
      ls -la /usr/local/bin/kubectl || echo "kubectl not found"
      
      echo "🔍 Testing secret access..."
      if /usr/local/bin/kubectl get secret gitea-admin-api-token -n gitea >/dev/null 2>&1; then
        echo "✅ Secret found!"
        TOKEN=$(/usr/local/bin/kubectl get secret gitea-admin-api-token -n gitea -o jsonpath='{.data.token}' | base64 -d)
        echo "Token length: ${#TOKEN}"
      else
        echo "❌ Secret not found!"
        echo "Available secrets:"
        /usr/local/bin/kubectl get secrets -n gitea
      fi
      
      echo "🔍 Waiting 30 seconds before exit..."
      sleep 30
    volumeMounts:
    - name: kubectl-binary
      mountPath: /usr/local/bin/kubectl
      subPath: kubectl
  volumes:
  - name: kubectl-binary
    emptyDir: {}