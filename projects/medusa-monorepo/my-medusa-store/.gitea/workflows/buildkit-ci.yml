name: Build and Push with BuildKit
on:
  push:
    branches: [main, master]

jobs:
  build:
    runs-on: ubuntu-latest
    container: moby/buildkit:master
    env:
      GITEA_SERVER_URL: ${{ gitea.server_url }}
      GITEA_ACTOR: ${{ gitea.actor }}
      GITEA_API_URL: ${{ gitea.api_url }}
      GITEA_REPOSITORY: ${{ gitea.repository }}
      IMAGE_BASE: medusa-app
      
    steps:
    - name: Main Build and push with buildctl
      run: |
        echo "Starting BuildKit CI/CD workflow..."
        
        # Install required tools
        apk add --no-cache git curl jq
        
        # Clone repository
        echo "Cloning repository..."
        git clone ${GITEA_SERVER_URL}/${GITEA_REPOSITORY}.git /workspace
        cd /workspace
        
        # Get commit info
        COMMIT_SHA=$(git rev-parse --short HEAD)
        BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
        echo "Building from branch: $BRANCH_NAME, commit: $COMMIT_SHA"
        
        # Start buildkitd daemon
        echo "Starting buildkitd daemon..."
        buildkitd --oci-worker-no-process-sandbox &
        sleep 5
        
        # Build and push image
        IMAGE_TAG="${BRANCH_NAME}-${COMMIT_SHA}"
        FULL_IMAGE="${GITEA_SERVER_URL#https://}/${GITEA_REPOSITORY}:${IMAGE_TAG}"
        
        echo "Building image: $FULL_IMAGE"
        buildctl build \
          --frontend dockerfile.v0 \
          --local context=. \
          --local dockerfile=. \
          --output type=image,name=$FULL_IMAGE,push=true,registry.insecure=true
        
        echo "Successfully built and pushed: $FULL_IMAGE"