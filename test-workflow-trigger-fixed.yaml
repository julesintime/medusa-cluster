---
# Fixed test workflow with proper service account (CLI-free trigger)
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: test-argocd-cicd-
  namespace: argocd
  labels:
    trigger: manual-test
    component: verification
spec:
  serviceAccountName: workflow-builder  # Use our custom service account
  entrypoint: test-workflow
  templates:
  - name: test-workflow
    dag:
      tasks:
      - name: hello-argo
        template: hello
      - name: check-cluster
        template: cluster-check
        dependencies: [hello-argo]

  - name: hello
    container:
      image: alpine:latest
      command: [echo]
      args: ["üéâ Argo Workflows + ArgoCD CI/CD is working! No CLI needed - pure Kubernetes!"]

  - name: cluster-check
    container:
      image: alpine:latest
      command: [sh, -c]
      args:
      - |
        echo "üîç ArgoCD CI/CD Cluster Check Results:"
        echo "========================================"
        echo "Namespace: argocd"
        echo "Workflow: {{workflow.name}}"
        echo "Timestamp: $(date)"
        echo "Service Account: workflow-builder"
        echo "Status: Argo Workflows functioning correctly"
        echo "‚úÖ Ready for complete CI/CD pipeline deployment"
        echo "========================================"
        echo ""
        echo "üöÄ Next Steps:"
        echo "1. Deploy Infisical secrets for portfolio"
        echo "2. Trigger full portfolio CI/CD pipeline"
        echo "3. Verify avada-portfolio application deployment"
        echo ""
        echo "üéØ Replacement Status:"
        echo "‚ùå Old: Gitea Act Runner + Tekton"
        echo "‚úÖ New: ArgoCD Workflows + Events + Applications"